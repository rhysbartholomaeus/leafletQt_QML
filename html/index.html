<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

    <!-- Leaflet -->

    <script src="qrc:///html/resources/leaflet/leaflet-src.js"></script>
    <link rel="stylesheet" href="qrc:///html/resources/leaflet/leaflet.css" />

    <!-- Leaflet Draw Plugin -->

    <script src="qrc:///html/resources/leaflet.draw/Leaflet.draw.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/Leaflet.Draw.Event.js"></script>
    <link rel="stylesheet" href="qrc:///html/resources/leaflet.draw/leaflet.draw.css" />
    <script src="qrc:///html/resources/leaflet.draw/Toolbar.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/Tooltip.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/GeometryUtil.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/LatLngUtil.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/LineUtil.Intersect.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/Polygon.Intersect.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/Polyline.Intersect.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/ext/TouchEvents.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/DrawToolbar.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Feature.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.SimpleShape.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Polyline.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Marker.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.CircleMarker.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Circle.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Polygon.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/draw/handler/Draw.Rectangle.js"></script> 
    <script src="qrc:///html/resources/leaflet.draw/edit/EditToolbar.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/EditToolbar.Edit.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/EditToolbar.Delete.js"></script> 
    <script src="qrc:///html/resources/leaflet.draw/Control.Draw.js"></script>  
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.Poly.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.SimpleShape.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.Marker.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.CircleMarker.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.Circle.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/edit/handler/Edit.Rectangle.js"></script>
    <script src="qrc:///html/resources/leaflet.draw/InitialiseLeafletDraw.js"></script>

    <!-- Leaflet RealTime Plugin -->

    <script src="qrc:///html/resources/leaflet.realtime/L.Realtime.js"></script>
    <script src="qrc:///html/resources/leaflet.realtime/QueryOpenSkyNetworks.js"></script>

    <!-- Leaflet Track Plugin -->

    <!-- <script src="./resources/geojson/convertToGEOJSON.js"></script> -->
    <script src="qrc:///html/resources/leaflet.tracksymbol/tracksymbol.js"></script>
    <!-- <link rel="stylesheet" href="./resources/css/flightradar.css" /> -->

    <!-- Qt Webchannel - Requires HTML to be loaded by QWebEngineView-->

    <script type="text/javascript" src="qrc:///html/resources/qwebchannel.js"></script>

    <!-- Moving marker addon -->

    <script type="text/javascript" src="qrc:///html/resources/Leaflet.MovingMarker/MovingMarker.js"></script>

    <!-- Test a moving aircraft -->

    <script type="text/javascript" src="qrc:///html/resources/leaflet.realtime/test_aircraft.js"></script>

    </head>
    <body>
        
        <div id="map" style="height:100%; width:100%;position:absolute; border: 1px solid rgb(9, 89, 143)"></div>

        <script>

            var map = new L.Map('map', {center: new L.LatLng(-35.022638, 138.904095), zoom: 5});

            // Layer for overlays to sit on.
            var drawnItems = L.featureGroup().addTo(map);

            var moveDrone = false;

            var createDrone = false;

            var moveSITLDrone = false;

            // layer for ADS-B tracks to sit on.
            var trackLayer = L.featureGroup()
            .on('click', function(){alert("Got click on Plane.");})
            .addTo(map);

            // layer for an Ardupilot SITL drone to sit on.
            var ardupilotLayer = L.featureGroup().addTo(map);
                
            //initiateArdupilotQuery(ardupilotLayer, map)

            // Test function - can be called from C++ or from Javascript
            function centerMap(lat, lng) {
                if (map.getCenter().lat != lat && map.getCenter().lng != lng) {
                    map.setZoom(14);
                    map.setView([lat, lng], map.zoom);
                    console.log('Using lat : ' + lat + ' | Using lng : ' + lng)
                }
            }

            var wmsLayer = L.tileLayer.wms('http://localhost:8080/geoserver/map_server/wms?', {
                layers: 'TOPO-OSM-WMS'
            }).addTo(map);

            var darkmarble = L.tileLayer.wms('http://localhost:8080/geoserver/map_server/wms?', {
                layers: 'BlackMarble_2016_D2_geo'
            }).addTo(map);

            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            })
            
            L.control.layers({
                    "wmsLayer": wmsLayer.addTo(map),
                    "darkmarble": darkmarble.addTo(map),
                    "osmLayer": osm.addTo(map)                    
                }, {'overlays':drawnItems}, { position: 'topright', collapsed: true }
                ).addTo(map);

            map.addControl(new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    poly : {
                        allowIntersection : false
                    }
                },
                draw: {
                    polygon : {
                        allowIntersection: false,
                        showArea:true
                    }
                }
            }));

            // Create the overlay tools - See resources/leaflet.draw/InitialiseLeafletDraw.js
            initialiseLeafletDraw(drawnItems, map);

            // Start the OpenSky Networks track query - See resources/leaflet.realtime/QueryOpenSkyNetworks.js
            initiateTrackQuery(trackLayer);

            // Placeholder to select drone
            var selectedDrone = false;

            // On click - drone selected
            trackLayer.on('click', function (event) {
                var clickedMarker = event.layer;
                // selectedDrone = true;
                console.log('Clicked on plane.' + clickedMarker);
            });
              
            // Inline function to provide ability to direct a drone - If it exists.
            // Sloppy way of doing this - markers should be per drone or similar - but proof-of-concept so YOLO
            var dronePosMarker = null;
            map.on('click', function(e) {
                if(moveDrone) {
                    var location = e.latlng;
                    console.log('Going to location: ' + location);
                    if(dronePosMarker != null){
                        ardupilotLayer.removeLayer(dronePosMarker);
                    }
                    dronePosMarker = L.marker(location,{
                        title: 'Drone moving here'
                    }).addTo(ardupilotLayer);
                    moveDrone = false;
                    window.commObject.logStr('Drone moving to location: ' + location.lat + "," + location.lng);
                    if(location != undefined && location.lat != undefined && location.lng != undefined){
                        window.commObject.setDroneTargetPosition(location.lat,location.lng);
                    }
                    transition(location);
                }
                if(createDrone){
                    initAircraft(ardupilotLayer,e.latlng);
                    createDrone = false;
                    //transition(e.latlng);
                }   
                
            });
        </script>
  </body>
</html>